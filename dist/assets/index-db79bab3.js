import{d as _,D as q,r as K,m as M,G as Y,c as s,x as he,H as we,q as J,L as Pe,M as be,N as ye}from"./index-e92d1c66.js";import{c as Q,C as E,n as G,v as Ie,p as W,D as O,L as Se,t as F,E as ae,a as U,f as ee,m as X,G as pe,H as xe,h as N,A as Ce,J as ze,I as H,r as De,e as $,w as ne,K as ie,l as Re,M as se,N as Te,z as ke,O as Ae}from"./index-a2f0c7ad.js";import{e as Fe,L as le,u as re,P as Le,m as Ze,d as Ue}from"./request-14faacb8.js";import{a as Xe,S as Me}from"./index-ef91f42b.js";import{I as ce}from"./index-e224cb23.js";import{c as ue}from"./interceptor-a823686a.js";const te=e=>Math.sqrt((e[0].clientX-e[1].clientX)**2+(e[0].clientY-e[1].clientY)**2),j=Q("image-preview")[1];var Oe=_({props:{src:String,show:Boolean,active:Number,minZoom:E(G),maxZoom:E(G),rootWidth:E(Number),rootHeight:E(Number),disableZoom:Boolean},emits:["scale","close","longPress"],setup(e,{emit:n,slots:r}){const t=q({scale:1,moveX:0,moveY:0,moving:!1,zooming:!1,imageRatio:0,displayWidth:0,displayHeight:0}),i=Fe(),w=K(),I=M(()=>{const{rootWidth:a,rootHeight:d}=e,u=d/a;return t.imageRatio>u}),C=M(()=>{const{scale:a,moveX:d,moveY:u,moving:x,zooming:A}=t,B={transitionDuration:A||x?"0s":".3s"};if(a!==1){const fe=d/a,ge=u/a;B.transform=`scale(${a}, ${a}) translate(${fe}px, ${ge}px)`}return B}),P=M(()=>{if(t.imageRatio){const{rootWidth:a,rootHeight:d}=e,u=I.value?d/t.imageRatio:a;return Math.max(0,(t.scale*u-a)/2)}return 0}),l=M(()=>{if(t.imageRatio){const{rootWidth:a,rootHeight:d}=e,u=I.value?d:a*t.imageRatio;return Math.max(0,(t.scale*u-d)/2)}return 0}),v=a=>{a=O(a,+e.minZoom,+e.maxZoom+1),a!==t.scale&&(t.scale=a,n("scale",{scale:a,index:e.active}))},y=()=>{v(1),t.moveX=0,t.moveY=0},h=()=>{const a=t.scale>1?1:2;v(a),t.moveX=0,t.moveY=0};let S,R,T,L,k,c,z,o=!1;const m=a=>{const{touches:d}=a;if(S=d.length,S===2&&e.disableZoom)return;const{offsetX:u}=i;i.start(a),R=t.moveX,T=t.moveY,z=Date.now(),o=!1,t.moving=S===1&&t.scale!==1,t.zooming=S===2&&!u.value,t.zooming&&(L=t.scale,k=te(a.touches))},b=a=>{const{touches:d}=a;if(i.move(a),t.moving){const{deltaX:u,deltaY:x}=i,A=u.value+R,B=x.value+T;if((A>P.value||A<-P.value)&&!o&&i.isHorizontal()){t.moving=!1;return}o=!0,W(a,!0),t.moveX=O(A,-P.value,P.value),t.moveY=O(B,-l.value,l.value)}if(t.zooming&&(W(a,!0),d.length===2)){const u=te(d),x=L*u/k;v(x)}},g=()=>{if(S>1)return;const{offsetX:a,offsetY:d}=i,u=Date.now()-z,x=250,A=5;a.value<A&&d.value<A&&(u<x?c?(clearTimeout(c),c=null,h()):c=setTimeout(()=>{n("close"),c=null},x):u>Se&&n("longPress"))},p=a=>{let d=!1;if((t.moving||t.zooming)&&(d=!0,t.moving&&R===t.moveX&&T===t.moveY&&(d=!1),!a.touches.length)){t.zooming&&(t.moveX=O(t.moveX,-P.value,P.value),t.moveY=O(t.moveY,-l.value,l.value),t.zooming=!1),t.moving=!1,R=0,T=0,L=1,t.scale<1&&y();const u=+e.maxZoom;t.scale>u&&(t.scale=u)}W(a,d),g(),i.reset()},D=a=>{const{naturalWidth:d,naturalHeight:u}=a.target;t.imageRatio=u/d};return Y(()=>e.active,y),Y(()=>e.show,a=>{a||y()}),Ie("touchmove",b,{target:M(()=>{var a;return(a=w.value)==null?void 0:a.$el})}),()=>{const a={loading:()=>s(le,{type:"spinner"},null)};return s(Xe,{ref:w,class:j("swipe-item"),onTouchstartPassive:m,onTouchend:p,onTouchcancel:p},{default:()=>[r.image?s("div",{class:j("image-wrap")},[r.image({src:e.src})]):s(ce,{src:e.src,fit:"contain",class:j("image",{vertical:I.value}),style:C.value,onLoad:D},a)]})}}});const[Ee,Z]=Q("image-preview"),Ne=["show","teleport","transition","overlayStyle","closeOnPopstate"],Ye={show:Boolean,loop:F,images:ae(),minZoom:U(1/3),maxZoom:U(3),overlay:F,closeable:Boolean,showIndex:F,className:ee,closeIcon:X("clear"),transition:String,beforeClose:Function,overlayClass:ee,overlayStyle:Object,swipeDuration:U(300),startPosition:U(0),showIndicators:Boolean,closeOnPopstate:F,closeIconPosition:X("top-right"),teleport:[String,Object]};var de=_({name:Ee,props:Ye,emits:["scale","close","closed","change","longPress","update:show"],setup(e,{emit:n,slots:r}){const t=K(),i=q({active:0,rootWidth:0,rootHeight:0,disableZoom:!1}),w=()=>{if(t.value){const c=Ce(t.value.$el);i.rootWidth=c.width,i.rootHeight=c.height,t.value.resize()}},I=c=>n("scale",c),C=c=>n("update:show",c),P=()=>{ue(e.beforeClose,{args:[i.active],done:()=>C(!1)})},l=c=>{c!==i.active&&(i.active=c,n("change",c))},v=()=>{if(e.showIndex)return s("div",{class:Z("index")},[r.index?r.index({index:i.active}):`${i.active+1} / ${e.images.length}`])},y=()=>{if(r.cover)return s("div",{class:Z("cover")},[r.cover()])},h=()=>{i.disableZoom=!0},S=()=>{i.disableZoom=!1},R=()=>s(Me,{ref:t,lazyRender:!0,loop:e.loop,class:Z("swipe"),duration:e.swipeDuration,initialSwipe:e.startPosition,showIndicators:e.showIndicators,indicatorColor:"white",onChange:l,onDragEnd:S,onDragStart:h},{default:()=>[e.images.map((c,z)=>s(Oe,{src:c,show:e.show,active:i.active,maxZoom:e.maxZoom,minZoom:e.minZoom,rootWidth:i.rootWidth,rootHeight:i.rootHeight,disableZoom:i.disableZoom,onScale:I,onClose:P,onLongPress:()=>n("longPress",{index:z})},{image:r.image}))]}),T=()=>{if(e.closeable)return s(H,{role:"button",name:e.closeIcon,class:[Z("close-icon",e.closeIconPosition),ze],onClick:P},null)},L=()=>n("closed"),k=(c,z)=>{var o;return(o=t.value)==null?void 0:o.swipeTo(c,z)};return re({swipeTo:k}),he(w),Y([pe,xe],w),Y(()=>e.startPosition,c=>l(+c)),Y(()=>e.show,c=>{const{images:z,startPosition:o}=e;c?(l(+o),we(()=>{w(),k(+o,{immediate:!0})})):n("close",{index:i.active,url:z[i.active]})}),()=>s(Le,J({class:[Z(),e.className],overlayClass:[Z("overlay"),e.overlayClass],onClosed:L,"onUpdate:show":C},N(e,Ne)),{default:()=>[T(),R(),v(),y()]})}});let V;const He={loop:!0,images:[],maxZoom:3,minZoom:1/3,onScale:void 0,onClose:void 0,onChange:void 0,teleport:"body",className:"",showIndex:!0,closeable:!1,closeIcon:"clear",transition:void 0,beforeClose:void 0,overlayStyle:void 0,overlayClass:void 0,startPosition:0,swipeDuration:300,showIndicators:!1,closeOnPopstate:!0,closeIconPosition:"top-right"};function Be(){({instance:V}=Ze({setup(){const{state:e,toggle:n}=Ue(),r=()=>{e.images=[]};return()=>s(de,J(e,{onClosed:r,"onUpdate:show":n}),null)}}))}const Ve=(e,n=0)=>{if(De)return V||Be(),e=Array.isArray(e)?{images:e,startPosition:n}:e,V.open($({},He,e)),V};ne(de);const[$e,f,_e]=Q("uploader");function oe(e,n){return new Promise(r=>{if(n==="file"){r();return}const t=new FileReader;t.onload=i=>{r(i.target.result)},n==="dataUrl"?t.readAsDataURL(e):n==="text"&&t.readAsText(e)})}function me(e,n){return ie(e).some(r=>r.file?Re(n)?n(r.file):r.file.size>+n:!1)}function We(e,n){const r=[],t=[];return e.forEach(i=>{me(i,n)?t.push(i):r.push(i)}),{valid:r,invalid:t}}const je=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg|avif)/i,Ge=e=>je.test(e);function ve(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?Ge(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}var qe=_({props:{name:G,item:E(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,previewSize:[Number,String,Array],beforeDelete:Function},emits:["delete","preview"],setup(e,{emit:n,slots:r}){const t=()=>{const{status:l,message:v}=e.item;if(l==="uploading"||l==="failed"){const y=l==="failed"?s(H,{name:"close",class:f("mask-icon")},null):s(le,{class:f("loading")},null),h=Te(v)&&v!=="";return s("div",{class:f("mask")},[y,h&&s("div",{class:f("mask-message")},[v])])}},i=l=>{const{name:v,item:y,index:h,beforeDelete:S}=e;l.stopPropagation(),ue(S,{args:[y,{name:v,index:h}],done:()=>n("delete")})},w=()=>n("preview"),I=()=>{if(e.deletable&&e.item.status!=="uploading"){const l=r["preview-delete"];return s("div",{role:"button",class:f("preview-delete",{shadow:!l}),tabindex:0,"aria-label":_e("delete"),onClick:i},[l?l():s(H,{name:"cross",class:f("preview-delete-icon")},null)])}},C=()=>{if(r["preview-cover"]){const{index:l,item:v}=e;return s("div",{class:f("preview-cover")},[r["preview-cover"]($({index:l},v))])}},P=()=>{const{item:l,lazyLoad:v,imageFit:y,previewSize:h}=e;return ve(l)?s(ce,{fit:y,src:l.content||l.url,class:f("preview-image"),width:Array.isArray(h)?h[0]:h,height:Array.isArray(h)?h[1]:h,lazyLoad:v,onClick:w},{default:C}):s("div",{class:f("file"),style:se(e.previewSize)},[s(H,{class:f("file-icon"),name:"description"},null),s("div",{class:[f("file-name"),"van-ellipsis"]},[l.file?l.file.name:l.url]),C()])};return()=>s("div",{class:f("preview")},[P(),t(),I()])}});const Ke={name:U(""),accept:X("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:U(1/0),imageFit:X("cover"),resultType:X("dataUrl"),uploadIcon:X("photograph"),uploadText:String,deletable:F,afterRead:Function,showUpload:F,modelValue:ae(),beforeRead:Function,beforeDelete:Function,previewSize:[Number,String,Array],previewImage:F,previewOptions:Object,previewFullImage:F,maxSize:{type:[Number,String,Function],default:1/0}};var Je=_({name:$e,props:Ke,emits:["delete","oversize","clickUpload","closePreview","clickPreview","update:modelValue"],setup(e,{emit:n,slots:r}){const t=K(),i=[],w=(o=e.modelValue.length)=>({name:e.name,index:o}),I=()=>{t.value&&(t.value.value="")},C=o=>{if(I(),me(o,e.maxSize))if(Array.isArray(o)){const m=We(o,e.maxSize);if(o=m.valid,n("oversize",m.invalid,w()),!o.length)return}else{n("oversize",o,w());return}o=q(o),n("update:modelValue",[...e.modelValue,...ie(o)]),e.afterRead&&e.afterRead(o,w())},P=o=>{const{maxCount:m,modelValue:b,resultType:g}=e;if(Array.isArray(o)){const p=+m-b.length;o.length>p&&(o=o.slice(0,p)),Promise.all(o.map(D=>oe(D,g))).then(D=>{const a=o.map((d,u)=>{const x={file:d,status:"",message:""};return D[u]&&(x.content=D[u]),x});C(a)})}else oe(o,g).then(p=>{const D={file:o,status:"",message:""};p&&(D.content=p),C(D)})},l=o=>{const{files:m}=o.target;if(e.disabled||!m||!m.length)return;const b=m.length===1?m[0]:[].slice.call(m);if(e.beforeRead){const g=e.beforeRead(b,w());if(!g){I();return}if(Ae(g)){g.then(p=>{P(p||b)}).catch(I);return}}P(b)};let v;const y=()=>n("closePreview"),h=o=>{if(e.previewFullImage){const m=e.modelValue.filter(ve),b=m.map(g=>(g.file&&!g.url&&g.status!=="failed"&&(g.url=URL.createObjectURL(g.file),i.push(g.url)),g.url)).filter(Boolean);v=Ve($({images:b,startPosition:m.indexOf(o),onClose:y},e.previewOptions))}},S=()=>{v&&v.close()},R=(o,m)=>{const b=e.modelValue.slice(0);b.splice(m,1),n("update:modelValue",b),n("delete",o,w(m))},T=(o,m)=>{const b=["imageFit","deletable","previewSize","beforeDelete"],g=$(N(e,b),N(o,b,!0));return s(qe,J({item:o,index:m,onClick:()=>n("clickPreview",o,w(m)),onDelete:()=>R(o,m),onPreview:()=>h(o)},N(e,["name","lazyLoad"]),g),N(r,["preview-cover","preview-delete"]))},L=()=>{if(e.previewImage)return e.modelValue.map(T)},k=o=>n("clickUpload",o),c=()=>{if(e.modelValue.length>=+e.maxCount)return;const o=e.readonly?null:s("input",{ref:t,type:"file",class:f("input"),accept:e.accept,capture:e.capture,multiple:e.multiple,disabled:e.disabled,onChange:l},null);return r.default?s("div",{class:f("input-wrapper"),onClick:k},[r.default(),o]):be(s("div",{class:f("upload",{readonly:e.readonly}),style:se(e.previewSize),onClick:k},[s(H,{name:e.uploadIcon,class:f("upload-icon")},null),e.uploadText&&s("span",{class:f("upload-text")},[e.uploadText]),o]),[[ye,e.showUpload]])},z=()=>{t.value&&!e.disabled&&t.value.click()};return Pe(()=>{i.forEach(o=>URL.revokeObjectURL(o))}),re({chooseFile:z,closeImagePreview:S}),ke(()=>e.modelValue),()=>s("div",{class:f()},[s("div",{class:f("wrapper",{disabled:e.disabled})},[L(),c()])])}});const it=ne(Je);export{it as U};
